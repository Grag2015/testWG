## Анализ жалобы от пассажиров на плохую работу транспорта на диспетчерской станции «Дружная» в период с 20:00 до 21:00.

выполнил: *Григорий Михолап*  
дата: *09/12/2015*

```{r setoptions, echo=FALSE, warning=FALSE, message=FALSE}
library(knitr)
opts_chunk$set(echo=FALSE, warning=FALSE, message=FALSE)
```

**Задание:**

В «Минсктранс» поступила жалоба от пассажиров на плохую работу транспорта на диспетчерской станции «Дружная» в период с 20:00 до 21:00. Суть жалобы состоит в том, что троллейбусы ходят не по расписанию и их приходится ждать очень долго на остановках. Необходимо разобраться в ситуации и выяснить, чем же вызвана жалоба, а также провести развернутый анализ времени движения транспорта и пассажиропотока.

**Результат кратко**:   
Причиной жалобы стала задержка маршрута 51, более подробно см. в данном отчете

**Замечание** по поводу программного кода:  
Программный код, который используется в отчете, в т.ч. и некоторые операции (такие как загрузка и подготовка данных для анализа) не были включены в отчет, при необходимости все эти данные вы можете найти [по ссылке](https://github.com/Grag2015/testWG/blob/master/Task%202%20Minsktrans.Rmd) 
```{r echo=FALSE, results='hide', warning=FALSE, message=FALSE}
# **Замечание** для воспроизводимости отчета:
# перед загрузкой вкладка "Статистика по троллейбусам" была сохранена в формате csv
# в файле с именем "Data Analyst (Financial) TZ Data_TMO.csv"
# (Выполнено в MS Excel 2010: Файл -> Сохранить как -> CSV (разделители - запятые))
```


```{r  echo=FALSE, results='hide', warning=FALSE, message=FALSE}
#  setwd("d:/Grag/R/R-studio/testWG/")
df <-  read.csv("Data Analyst (Financial) TZ Data_TMO.csv", sep = ";")
# переименуем столбцы
names(df) <- c("number","time","pass")
# преобразуем время к внутреннему формату для хранения дат
df$time <- strptime(df$time, format = "%H:%M")

```

```{r  echo=FALSE, results='hide', warning=FALSE, message=FALSE}
# Подключаем нужные библиотеки
library("dplyr")
library("ggplot2")
library("lattice") 
library("xtable")
library("car")
library(lubridate)
```

```{r}
# Рассчитываем интервалы движения (данные вносим в дополнительный столбец `interval`)
df$interval <- numeric(length = nrow(df))
for (i in 1:length(unique(df$number))) {
    temp <- df[df$number==unique(df$number)[i],"time"]
    temp2 <- numeric(length = length(temp))
    for (j in 2:length(temp)) {        
        temp2[j]=as.integer(temp[j]-temp[j-1])
    }
    is.na(temp2[1]) <- T
    df[df$number==unique(df$number)[i],]$interval <- temp2
}
```

```{r}
# Дополнительно добавим такой показатель, как время ожидания в пассажиро-минутах
df$passmin <- df$pass*df$interval/2 # делим на 2 предполагая, что в среднем люди приходят на остановку в середине интервала 
# вектор суммарного ожидания в разбивке по 10-минуткам
wait <- integer(length = 6)
for (i in 1:6) {
    wait[i] <- sum(df[minute(df$time)+(hour(df$time)-20)*60>=(i-1)*10 & 
                          minute(df$time)+(hour(df$time)-20)*60<(i)*10,"passmin"], na.rm = T)
}
```


## Общие характеристики работы транспорта на диспетчерской станции «Дружная» в интервале времени с 20:00 до 21:00. 
На основании предоставленных данных были расчитаны основные характеристики работы троллейбусов на ДС "Дружная"" в интервале времени с 20:00 до 21:00

Показатель  | Все маршруты | Маршрут №27 | Маршрут №31 | Маршрут №51
------------- | ------------- | ------------- | ------------- | -------------
Средний интервал движения (мин)  | `r round(mean(df$interval, na.rm=T),2)` |  `r round(mean(df[df$number==27,]$interval, na.rm=T),2)` |  `r round(mean(df[df$number==31,]$interval, na.rm=T),2)` |  `r round(mean(df[df$number==51,]$interval, na.rm=T),2)`
Отклонение от среднего интервала (мин)  | `r round(sd(df$interval, na.rm=T),2)` |  `r round(sd(df[df$number==27,]$interval, na.rm=T),2)` | `r round(sd(df[df$number==31,]$interval, na.rm=T),2)`  | `r round(sd(df[df$number==51,]$interval, na.rm=T),2)`
Максимальное значение интервала (мин)  | `r round(max(df$interval, na.rm=T),2)` |  `r round(max(df[df$number==27,]$interval, na.rm=T),2)` | `r round(max(df[df$number==31,]$interval, na.rm=T),2)`  | `r round(max(df[df$number==51,]$interval, na.rm=T),2)`
Среднее кол-во пассажиров (чел) | `r round(mean(df$pass, na.rm=T),0)` |  `r round(mean(df[df$number==27,]$pass, na.rm=T),0)` | `r round(mean(df[df$number==31,]$pass, na.rm=T),2)`  | `r round(mean(df[df$number==51,]$pass, na.rm=T),0)`
Суммарное кол-во пассажиров (чел) | `r round(sum(df$pass, na.rm=T),2)` |  `r round(sum(df[df$number==27,]$pass, na.rm=T),2)` | `r round(sum(df[df$number==31,]$pass, na.rm=T),2)`  | `r round(sum(df[df$number==51,]$pass, na.rm=T),2)`

Комментарии к таблице - в среднем интервал ожидания троллейбуса на станции "Дружная" в период с 20:00 до 21:00 составляет 5 минут, при этом в реальности троллейбусы по ряду причин не всегда зависящих от водителя, могут отклониться от среднего, т.е. прибыть раньше либо позже. Среднее значение такого отклонения составляет примерно 1.7 минуты (см. 'Отклонение от среднего (мин)'), 
Высокое значение данного показателя говорит о частых и значительных отклонениях от расписания, что влечет дополнительные сложности для пассажиров, которым становится тяжелей "словить" троллейбус, и 
является причиной неравномерной загрузки транспорта. По этой причине хочется отметить маршрут №51, для которого данный параметр гораздо выше среднего по станции (к этому вопросу мы еще вернемся чуть ниже), при этом мы видим значительную задержку в движении - троллейбуса ждали `r round(max(df[df$number==51,]$interval, na.rm=T),2)` минут. (ниже мы еще вернемся к этой задержке)

*Замечание*: для средних интервалов движения были выполнены тесты Стьюдента на значимость различий - все различия значимы (детали см. в коде отчета)
```{r results='hide'}
t1 <- df[df$number==31,"interval"]
t2 <- df[df$number==27,"interval"]
t.test(t1,t2)

t1 <- df[df$number==31,"interval"]
t2 <- df[df$number==51,"interval"]
t.test(t1,t2)

t1 <- df[df$number==27,"interval"]
t2 <- df[df$number==51,"interval"]
t.test(t1,t2)
```


Визуализация основных показателей
```{r results='asis'}
# подготовка данных для графика
averinter <- tapply(df$interval, factor(df$number), function(e) mean(e, na.rm = T))
averpass <- tapply(df$pass, factor(df$number), function(e) mean(e, na.rm = T))
sumpass <- tapply(df$pass, factor(df$number), function(e) sum(e, na.rm = T))
df2 <- data.frame(interval=averinter, pass=averpass, sumpass=sumpass, number=names(sumpass))
```

```{r  fig.width=10,  fig.height=8}
ggplot(data=df2, aes(x=interval, y=pass, size=factor(sumpass), col=factor(number)))+geom_point(size=c(12,20,9))+xlim(0,10)+ylim(5,20)+geom_vline(xintercept = mean(df$interval, na.rm = T), colour="red", linetype = "longdash", size=0.5)+geom_hline(yintercept = mean(df$pass, na.rm = T), colour="red", linetype = "longdash", size=0.5)+annotate("text", label = paste0(df2$sumpass," пасс/час"), x = df2$interval, y = df2$pass, size = 3, colour = "#2e3a23",  hjust=-0.2)+
    xlab("Средний интервал движения(мин)")+
    ylab("Среднее количество пассажиров (чел)")+
    labs(title="Основные показатели маршрутов")+
    scale_color_discrete(name="Маршрут")
```

Как видим, наибольший пассажиропоток на маршруте №31 (224 пассажира в час), при этом средний интервал движения на маршруте ниже среднего показателя по станции, а средняя загрузка троллейбуса составляет 14 человек, что также выше среднего по станции, т.е. можно сказать, что по этим показателям маршрут №31 показывает хороший уровень (выше среднего).  
Маршрут №27 по среднему интервалу на среднем уровне, но ниже среднего по загрузке - в троллейбус на ДС Дружная в среднем заходит 10 человек. (возможно стоит обратить внимание на этот показатель).  
Маршрут №51 имеет максимальный (среди рассмотренных маршрутов) средний интервал движения и максимальную загрузку. Ниже мы покажем, что скорее всего большой интервал движения маршрута №51 и является причиной жалобы.

Посмотрим на пассажиропоток в динамике по времени

```{r  fig.width=10,  fig.height=8}
ggplot(data = df, aes(x=time, y=pass))+geom_line(aes(col=factor(number)))+geom_point(aes(col=factor(number)))+xlab("Время прибытия троллейбуса")+
    ylab("Количество пассажиров (чел)")+
    labs(title="Хронология пассажиропотока в разбивке по маршрутам")+
    scale_color_discrete(name="Маршрут")

```

1. Можно отметить, что в рассматриваемом промежутке пассажиропоток значительно падает. При это на маршруте №51, это падение не такое стремительное.  
2. На маршруте №51 мы видим в райне 20:55 значительный всплеск ожидающих, сопоставив с интервалами движения в течение часа (см. график ниже), мы видим, что этот пик приходится на ту максимульную задержку в `r round(max(df[df$number==51,]$interval, na.rm=T),2)` минут, которую мы обнаружили выше. Также стоит обратить внимание, что возможно в этом время прибывает на вокзал вечерняя электричка, что также влечет дополнительный прирост пассажиров (даже без задержек в движении троллейбусов) и это надо, по возможности, учитывать при составлении расписания.

```{r  fig.width=10,  fig.height=8}
ggplot(data=df, aes(x=time, y=interval, fill=factor(number)), col="white")+geom_histogram(stat="identity", position="dodge")+xlab("Время прибытия троллейбуса")+
    ylab("Средний интервал ожидания троллейбуса (мин)")+
    labs(title="Хронология прибытия и интервалы ожидания")+
    scale_fill_discrete(name="Маршрут")
```


Анализ времени ожидания в пассажиро-минутах. 
Предлагаю проанализировать такой показатель, как время ожидания в т.н. пассажиро-минутах, т.е. когда мы умножаем время ожидания на число ожидающих, например, если троллейбуса не было 5 минут и в это время его на остановке ожидало 10 человек, то время ожидания составляет 50 пасс-мин(10 пассажиров умножить на 5 минут) и чем выше этот показатель для маршрута, тем больше будет недовольных пассажиров и больше жалоб.

Показатель  | Все маршруты | Маршрут №27 | Маршрут №31 | Маршрут №51
------------- | ------------- | ------------- | ------------- | -------------
Среднее время ожидания (пасс/мин) | `r round(mean(df$passmin, na.rm=T),0)` |  `r round(mean(df[df$number==27,]$passmin, na.rm=T),0)` | `r round(mean(df[df$number==31,]$passmin, na.rm=T),2)`  | `r round(mean(df[df$number==51,]$passmin, na.rm=T),0)`
Суммарное время ожидания (пасс/мин) | `r round(sum(df$passmin, na.rm=T),2)` |  `r round(sum(df[df$number==27,]$passmin, na.rm=T),2)` | `r round(sum(df[df$number==31,]$passmin, na.rm=T),2)`  | `r round(sum(df[df$number==51,]$passmin, na.rm=T),2)`

```{r fig.width=10,  fig.height=8}
ggplot(data = df, aes(x=time, y=passmin))+geom_line(aes(col=factor(number)))+geom_point(aes(col=factor(number)))+xlab("Время прибытия троллейбуса")+
    ylab("Время ожидания в пассажиро-минутах")+
    labs(title="Время ожидания по маршрутам в пассажиро-минутах")+
    scale_color_discrete(name="Маршрут")

```
Как видим по показателю Среднее время ожидания (пасс-мин) маршрут №51 опережает остальные, это наталкивает на предположение о том, что на этот маршрут (по причине ожидания или отклонения от графика) будут жаловаться чаще, чем на остальные. 

## Резюме
в качестве резюме приведу ответ на основной вопрос

> найти причину жалобы, 

Причина жалобы видимо состоит, в том, что в районе 20:55 маршрут №51 значительно (на 4 минуты) отклонился от среднего интервала (люди ждали 11 минут вместо привычных 7) и на остановке собралось почти 20 человек (вместо обычных для второй половины часа 10 человек)