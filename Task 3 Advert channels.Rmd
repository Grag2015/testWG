## Прогнозирование эффективности каналов регистрации пользователей.

выполнил: *Григорий Михолап*  
дата: *09/12/2015*

```{r setoptions, echo=FALSE, warning=FALSE, message=FALSE}
# глобальные настройки для chunks
library(knitr)
opts_chunk$set(echo=FALSE, warning=FALSE, message=FALSE)
```

```{r echo=FALSE, results='hide'}
# пользовательская ф-я для вывода параметров регрессионной модели
printlm <- function(model){
  tempsum <- summary(model)
  cat("Residual standard error:", format(signif(tempsum$sigma, 
                                                4)), "on", tempsum$df[2L], "degrees of freedom")
  cat("\n")
  cat("Multiple R-squared:  ", round(tempsum$r.squared, digits=4),	"Adjusted R-squared:  ",
      round(tempsum$adj.r.squared, digits=4))
  cat("\n")
  cat("F-statistic: ", round(tempsum$fstatistic[1],2), "on", round(tempsum$fstatistic[2],0), 
      "and", round(tempsum$fstatistic[3],0), "DF,  p-value:",
      format.pval(pf(tempsum$fstatistic[1L],tempsum$fstatistic[2L], 
                     tempsum$fstatistic[3L], lower.tail = FALSE)))
}
```

**Задание:**

Существует четыре рекламных канала регистраций пользователей A, B, C и D. В сентябре канал D был удален, и по май включительно существовало только три рекламных канала. В июне предполагается снова ввести рекламный канал D. Необходимо определить будущее значение регистраций на нем в июне. Количество регистраций по периодам на каждом канале представлено в файле “Данные для статобработки.xls” на вкладке “Рекламные каналы”..

**Выводы кратко:** 
Прогноз для остановленного канала выполнен на основании данных о результативности данного канала в первые 3 месяца его работы с учетом тренда (рассчитанного на основании данных по 3-м работающим каналам). Спрогнозированное на июнь количество регистраций равно 135.  Подробности см. в отчете ниже. 

## Загрузка и подготовка данных для анализа
Программный код, который используется в отчете, в т.ч. и некоторые операции (такие как загрузка и подготовка данных для анализа) не были включены в отчет, при необходимости все эти данные вы можете найти [по ссылке](https://github.com/Grag2015/testWG/blob/master/Task%202%20Minsktrans.Rmd) 
```{r echo=FALSE, results='hide', warning=FALSE, message=FALSE}
# **Замечание** для воспроизводимости работы:
# перед загрузкой вкладка "Статистика по троллейбусам" была сохранена в формате csv
# в файле с именем "Data Analyst (Financial) TZ Data_adchan.csv"
# (Выполнено в MS Excel 2010: Файл -> Сохранить как -> CSV (разделители - запятые))
```


```{r  echo=FALSE, results='hide', warning=FALSE, message=FALSE}
#  setwd("d:/Grag/R/R-studio/testWG/")
# читаем данные
df <-  read.csv("Data Analyst (Financial) TZ Data_adchan.csv", sep = ";")
# переименуем столбцы
names(df) <- c("period","A","B", "C", "D")
# упорядочим месяцы согласно условию задачи от июня до мая
df$period <- factor(df$period, ordered = T, levels = c("июнь", "июль", "август", "сентябрь", "октябрь", "ноябрь", "декабрь", "январь", "февраль", "март", "апрель", "май"))
# добавим новый столбец со средним числом регистраций
df$AVERAGE <- (df$A+df$B+df$C)/3
```

```{r  echo=FALSE, results='hide', warning=FALSE, message=FALSE}
# Подключаем нужные библиотеки
library("dplyr")
library("ggplot2")
library("lattice") 
library("xtable")
library("car")
library(lubridate)
library(reshape2)
```

```{r}
# "расплавим" таблицу
dfm <- melt(data=df, id = "period", measure = c("A", "B", "C", "D", "AVERAGE"))
names(dfm)[2] <- "channel"
names(dfm)[3] <- "reg"
# dfm <- dfm[order(dfm$period),]
# dfm$period <- as.character(dfm$period)
```

## Анализ данных
Посмотрим на средние показатели предоставленных данных   

Показатель  | Канал A | Канал B | Канал С | Канал D | Все каналы
------------- | ------------- | ------------- | ------------- | ------------- | -------------
Среднее число регистраций в месяц | `r round(mean(df$A),0)` | `r round(mean(df$B),0)` | `r round(mean(df$C),0)` | `r round(mean(df$D, na.rm=T),0)` | `r round(mean(df$AVERAGE),0)`
Среднее отклонение | `r round(sd(df$A),0)` | `r round(sd(df$B),0)` | `r round(sd(df$C),0)` | `r round(sd(df$D, na.rm=T),0)` | `r round(sd(df$AVERAGE),0)`

Мы видим, что Канал С наиболее результативный, на втором месте канал В, на третьем канал А, канал D, значение по которому предстоит спрогнозировать показал за 3 месяца совсем невысокие показатели, и привел в июне-августе не более 10% от всех регистраций..
Однако, важно отметить, что кроме числа регистраций, необходимо еще учитывать и стоимость привлечения одной регистрации, возможно по этому показателю канал D может быть интересен. Впрочем, анализ эффективности каналов выходит за рамки данного отчета.

Далее, посмотрим на показатели регистрации по каналам во временной динамике (см. диаграмму)
```{r  fig.width=10,  fig.height=8}
ggplot(data=dfm[dfm$channel!="AVERAGE",], aes(x=period, y=reg, col=channel, group=channel))+geom_point(size=3) + geom_smooth(method = "lm")+xlab("месяц")+ylab("количество регистраций")
```
Мы видим, что каналы А и В показывают положительную динамику, а лидирующий канал С оставался на одном уровне в течение 12 месяцев. Можно сказать, что в целом наблюдается положительный тренд, посмотрим более внимательно на среднюю регистрацию по каналам А, В и С (см. график ниже) 

```{r  fig.width=10,  fig.height=8}
ggplot(data=dfm[dfm$channel=="AVERAGE",], aes(x=period, y=reg, col=channel, group=channel))+geom_point()+geom_line()+ylim(270,370) + geom_smooth(method = "lm", col="blue")+xlab("месяц")+ylab("количество регистраций")

```
На данном графике мы видим некоторые сезонные колебания, например, предновогоднее падение в декабре, а также резкое падение в марте. Но, в рамках данной задачи, следует обратить внимание не на сезонные колебания, а на положительный тренд, который обозначен синей линией на графике. 
```{r}
fit <- lm(AVERAGE ~ as.numeric(period), data = df) 
```
Данный тренд показывает, что за 12 месяцев (с июня по май) число регистраций выросло на `r round((fitted.values(fit)[12]/fitted.values(fit)[1]-1),2)*100`%, это свидетельствует о росте популярности нашего сервиса. (при условии, что бюджеты на каналах не увеличивались от месяца к месяцу)

*Замечание*: Данная линейная аппроксимация построена методом наименьших квадратов. 
В таблице представлены показатели данной линейной модели. (как видим, все коэффициенты статистически значимы (p-value<0.05) и поэтому можно утверждать, что данный тренд не случайный)

```{r echo=FALSE, results='hold'}
printlm(fit)
```
```{r results='asis',  echo=FALSE}
xt <- xtable(summary(fit))
print(xt, type="html")
```

(все детали доступны [по ссылке]())

Теперь перейдем непосредственно к ответу на исходный вопрос "будущее значение регистраций на канале D в июне". Для оценки искомого значения предлагаю применить к базовому значению наш тренд, за базу предлагаю взять среднее арифметическое по каналу D в июле (оно, кстати, равно среднему за лето по каналу D, что также говорит в пользу нашего выбора), т.о. т.к. тренд выражен линейной функцией, то легко найти **прогноз значения на июнь** - `r round(fitted.values(fit)[12]-fitted.values(fit)[1]+100,2)`

Иллюстрация на графике
```{r}
dfm$period <- factor(dfm$period, ordered = T, levels = c("июнь", "июль", "август", "сентябрь", "октябрь", "ноябрь", "декабрь", "январь", "февраль", "март", "апрель", "май", "июнь2"))
t <- list("июнь2", "D", round(fitted.values(fit)[12]-fitted.values(fit)[1]+100,2),0)
dfm <- rbind(dfm, t)

```
```{r  fig.width=10,  fig.height=8}
ggplot(data=dfm[dfm$channel %in% c("AVERAGE","D"),], aes(x=period, y=reg, col=channel, group=channel))+geom_point(size=3)+geom_line()+ylim(50,400) + geom_smooth(method = "lm", col="blue")+xlab("месяц")+ylab("количество регистраций")

```
расписать какие факторы еще могут повлиять на данную оценку, можно ли оценить точность данного прогноза?